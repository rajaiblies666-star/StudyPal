<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StudyPal ‚Äî Platform Belajar Kolaboratif (Multi-Level)</title>
  <style>
    /* ===== Global styles ===== */
    :root{
      --bg:#f6fbff;
      --card:#ffffff;
      --primary:#0b6fb6; /* main blue */
      --primary-600:#075691;
      --muted:#6b7b8c;
      --accent:#e8f4ff;
      --glass: rgba(255,255,255,0.6);
      --radius:12px;
      --shadow: 0 6px 18px rgba(11,111,182,0.08);
      --mono: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      --notification: #ff5252;
      --smp-color: #FF9800; /* Orange */
      --sma-color: #2196F3; /* Blue */
      --leaderboard-gold: #FFD700;
      --leaderboard-silver: #C0C0C0;
      --leaderboard-bronze: #CD7F32;
      --development-bg: linear-gradient(90deg, #ff6b6b, #feca57);
      --development-border: #ff9ff3;
      --development-text: #2c2c54;
      --development-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--mono);
      background: linear-gradient(180deg, var(--bg) 0%, #f1f7fc 100%);
      color:#16324f;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding-bottom:60px;
    }

    /* Development Banner */
    .development-banner {
      background: var(--development-bg);
      border-bottom: 3px solid var(--development-border);
      color: var(--development-text);
      padding: 16px 20px;
      text-align: center;
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: var(--development-shadow);
      position: sticky;
      top: 0;
      z-index: 100;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.8; }
      100% { opacity: 1; }
    }
    .development-banner .icon {
      font-size: 24px;
      animation: bounce 1s infinite;
    }
    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
      40% { transform: translateY(-10px); }
      60% { transform: translateY(-5px); }
    }
    .development-banner .text {
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    /* ===== Header ===== */
    header{
      position:sticky;
      top: 80px; /* Adjusted for banner */
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,0.6);
      border-bottom:1px solid #e6eef8;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      padding:12px 20px;
      z-index:50;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;height:44px;
      border-radius:10px;
      background:linear-gradient(135deg,var(--primary),var(--primary-600));
      display:flex;align-items:center;justify-content:center;color:white;font-weight:700;
      font-size:18px;box-shadow:var(--shadow);
    }
    .brand h1{margin:0;font-size:18px}
    nav{display:flex;gap:10px;align-items:center}
    .btn{
      padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
      background:var(--primary);color:#fff;box-shadow:0 6px 14px rgba(11,111,182,0.12)
    }
    .btn.secondary{
      background:transparent;color:var(--primary);border:1px solid rgba(11,111,182,0.12);
      box-shadow:none;font-weight:600;
    }
    .btn.leaderboard {
      background: linear-gradient(135deg, var(--leaderboard-gold), #ffed4e);
      color: #333;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
    }
    .user-chip{display:flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:rgba(11,111,182,0.06);color:var(--primary);font-weight:600;cursor:pointer;position:relative}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--notification);color:white;border-radius:50%;width:18px;height:18px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold}
    .small{font-size:13px;color:var(--muted)}
    .current-level-indicator {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }
    .level-smp { background: var(--smp-color); }
    .level-sma { background: var(--sma-color); }

    /* ===== Level Selection View ===== */
    #levelSelectionView {
      padding: 40px 0;
      text-align: center;
    }
    .level-selection-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 20px;
    }
    .level-selection-title {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .level-selection-subtitle {
      font-size: 18px;
      color: var(--muted);
      margin-bottom: 40px;
    }
    .level-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 30px;
    }
    .level-card {
      background: var(--card);
      border-radius: 16px;
      padding: 30px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 2px solid transparent;
    }
    .level-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(11,111,182,0.15);
    }
    .level-card.smp { border-color: var(--smp-color); }
    .level-card.sma { border-color: var(--sma-color); }
    .level-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    .level-card.smp .level-icon { color: var(--smp-color); }
    .level-card.sma .level-icon { color: var(--sma-color); }
    .level-card h3 {
      margin: 0 0 5px 0;
      font-size: 24px;
    }
    .level-card p {
      margin: 0;
      color: var(--muted);
    }

    /* ===== Dashboard View ===== */
    #dashboardView { display: none; }
    .container{max-width:1100px;margin:28px auto;padding:0 18px}
    .hero{
      display:grid;grid-template-columns:1fr 380px;gap:22px;align-items:center;
    }
    .hero-card{
      background:var(--card);padding:28px;border-radius:16px;box-shadow:var(--shadow);
    }
    .hero h2{margin:0 0 6px;font-size:24px}
    .hero p{margin:0 0 16px;color:var(--muted)}
    .hero-actions{display:flex;gap:12px;align-items:center}
    .grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-top:18px;
    }
    .card{
      background:var(--card);padding:14px;border-radius:12px;box-shadow:var(--shadow);
    }
    .subject{
      display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;border:1px solid #f1f6fb;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .subject:hover {
      background-color: var(--accent);
    }
    .subject .icon{
      width:56px;height:56px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;
    }
    .s-math{background:linear-gradient(135deg,#0b6fb6,#3aa0ff)}
    .s-phys{background:linear-gradient(135deg,#ff8a65,#ffb86b)}
    .s-bio{background:linear-gradient(135deg,#4caf50,#8bdc91)}
    .s-eng{background:linear-gradient(135deg,#9c27b0,#c18ce8)}
    .s-pai{background:linear-gradient(135deg,#4caf50,#8bc34a)}
    .s-geo{background:linear-gradient(135deg,#795548,#a1887f)}
    .s-info{background:linear-gradient(135deg,#607d8b,#90a4ae)}
    .s-jawa{background:linear-gradient(135deg,#ff9800,#ffb74d)}
    .s-indo{background:linear-gradient(135deg,#f44336,#e57373)}
    .s-ipa{background:linear-gradient(135deg,#00bcd4,#4dd0e1)}
    .s-ips{background:linear-gradient(135deg,#ffeb3b,#fff176)}

    /* ===== Group & forum view ===== */
    .layout{
      display:grid;grid-template-columns:280px 1fr;gap:18px;margin-top:18px;
    }
    .sidebar{
      position:sticky;top:164px;align-self:start;
    }
    .group-list{display:flex;flex-direction:column;gap:10px}
    .group-item{padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef6fc;cursor:pointer}
    .group-item.active{border:2px solid var(--primary);box-shadow:0 8px 20px rgba(11,111,182,0.06)}
    .new-group{display:flex;gap:8px;margin-top:12px}
    .input{padding:10px;border-radius:10px;border:1px solid #e6eef8;flex:1}
    .input.full-width{width:100%}

    /* forum */
    .forum{
      display:flex;flex-direction:column;gap:12px;
    }
    .post{
      padding:12px;border-radius:10px;background:var(--card);border:1px solid #eef6fc;box-shadow:var(--shadow);
    }
    .post .meta{font-size:13px;color:var(--muted);display:flex;justify-content:space-between}
    .reply-list{margin-top:8px;display:flex;flex-direction:column;gap:8px;padding-left:8px}
    
    /* File sharing */
    .file-attachment{margin-top:8px;padding:8px;background:#f8f9fa;border-radius:8px;display:flex;align-items:center;gap:8px}
    .file-icon{width:32px;height:32px;background:#e3f2fd;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#1976d2}
    .file-info{flex:1}
    .file-name{font-weight:600;font-size:14px}
    .file-size{font-size:12px;color:var(--muted)}
    .file-actions{display:flex;gap:4px}
    .file-actions button{padding:4px 8px;font-size:12px;border-radius:6px}
    
    /* Notification panel */
    .notification-panel{position:absolute;top:140px;right:0;background:var(--card);border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.12);width:320px;max-height:400px;overflow-y:auto;z-index:100;display:none}
    .notification-header{padding:12px;border-bottom:1px solid #eef6fc;font-weight:700}
    .notification-list{padding:8px}
    .notification-item{padding:10px;border-radius:8px;margin-bottom:6px;background:#f8f9fa;cursor:pointer}
    .notification-item.unread{background:#e3f2fd}
    .notification-time{font-size:11px;color:var(--muted)}
    
    /* Profile View */
    .profile-view{display:none}
    .profile-header{display:flex;gap:20px;align-items:center;margin-bottom:24px}
    .profile-avatar-large{width:100px;height:100px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:40px;color:var(--primary);font-weight:700}
    .profile-info h2{margin:0 0 4px 0}
    .profile-info .small{margin:0}
    .profile-content{display:grid;grid-template-columns:1fr 1fr;gap:20px}
    .profile-section h3{margin:0 0 12px 0;font-size:18px}
    .profile-stats{display:flex;gap:20px;margin-bottom:20px}
    .profile-stat{text-align:center}
    .profile-stat-value{font-size:24px;font-weight:700}
    .profile-stat-label{font-size:13px;color:var(--muted)}
    .profile-list{display:flex;flex-direction:column;gap:10px}
    .profile-list-item{padding:12px;background:#f8f9fa;border-radius:8px;border:1px solid #eef6fc}
    .profile-list-item-title{font-weight:600}
    .profile-list-item-meta{font-size:12px;color:var(--muted)}
    
    /* Quiz categories */
    .quiz-categories{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
    .quiz-category{padding:6px 12px;border-radius:20px;background:#e3f2fd;color:var(--primary);font-size:13px;cursor:pointer}
    .quiz-category.active{background:var(--primary);color:white}
    
    /* Leaderboard Modal */
    #leaderboardModal .modal {
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .leaderboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .leaderboard-header h3 {
      margin: 0;
      color: var(--primary);
    }
    .leaderboard-header .btn.secondary {
      font-size: 13px;
    }
    .leaderboard-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      border-bottom: 1px solid #eef6fc;
    }
    .leaderboard-tab {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 600;
      color: var(--muted);
      transition: all 0.2s ease;
    }
    .leaderboard-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .leaderboard-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .leaderboard-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--card);
      border-radius: var(--radius);
      margin-bottom: 12px;
      box-shadow: var(--shadow);
      transition: transform 0.2s ease;
    }
    .leaderboard-item:hover {
      transform: translateY(-2px);
    }
    .leaderboard-rank {
      font-size: 20px;
      font-weight: 700;
      width: 40px;
      text-align: center;
    }
    .rank-1 { color: var(--leaderboard-gold); }
    .rank-2 { color: var(--leaderboard-silver); }
    .rank-3 { color: var(--leaderboard-bronze); }
    .leaderboard-rank .rank-medal {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }
    .rank-1 .rank-medal { background: var(--leaderboard-gold); }
    .rank-2 .rank-medal { background: var(--leaderboard-silver); }
    .rank-3 .rank-medal { background: var(--leaderboard-bronze); }
    .leaderboard-info {
      flex-grow: 1;
      margin-left: 16px;
    }
    .leaderboard-name {
      font-weight: 600;
      font-size: 16px;
    }
    .leaderboard-meta {
      font-size: 13px;
      color: var(--muted);
    }
    .leaderboard-score {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
    }
    .empty-leaderboard {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    .empty-leaderboard-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    /* Quiz Result Styles */
    .quiz-result-details {
      margin-top: 16px;
      padding: 12px;
      background-color: #f8f9fa;
      border-radius: var(--radius);
      border: 1px solid #eef6fc;
    }
    .quiz-result-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }
    .quiz-result-item:last-child {
      margin-bottom: 0;
    }
    .quiz-result-icon {
      font-size: 20px;
    }
    .correct { color: #4caf50; }
    .incorrect { color: #f44336; }
    .quiz-result-content {
      flex-grow: 1;
    }
    .quiz-result-question {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .quiz-result-answer {
      font-size: 14px;
    }
    .quiz-result-answer.correct {
      color: #2e7d32;
    }
    .quiz-result-answer.incorrect {
      color: #c62828;
      text-decoration: line-through;
    }
    .quiz-result-feedback {
      font-size: 13px;
      font-style: italic;
      color: var(--muted);
    }

    /* footer */
    footer{display:flex;justify-content:center;padding:18px;margin-top:30px;color:var(--muted)}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(6,20,36,0.36);display:none;align-items:center;justify-content:center;z-index:90}
    .modal{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:640px;box-shadow:0 16px 40px rgba(6,20,36,0.18)}
    .modal.show{display:flex}

    /* responsive */
    @media (max-width:880px){
      .hero{grid-template-columns:1fr;gap:14px}
      .layout{grid-template-columns:1fr;align-items:start}
      .sidebar{position:static}
      .profile-content{grid-template-columns:1fr}
      .level-cards { grid-template-columns: 1fr; }
      .development-banner { font-size: 14px; padding: 12px; }
    }
  </style>
<script type="module">
  // Import functions you need from SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, getDoc, updateDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
  
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyC_38dL0qBf_3InAGxgQBKB1Gh3voCQMTU",
    authDomain: "studypal-2c4da.firebaseapp.com",
    projectId: "studypal-2c4da",
    storageBucket: "studypal-2c4da.firebasestorage.app",
    messagingSenderId: "263468645535",
    appId: "1:263468645535:web:637152446b7ea24f5c36aa",
    measurementId: "G-8BJF7N5EG2"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Fungsi untuk membuat grup baru
  async function createGroupInDB(name, subject) {
    try {
      const docRef = await addDoc(collection(db, "groups"), {
        name: name,
        subject: subject,
        createdAt: new Date(),
        members: []
      });
      console.log("Group created with ID: ", docRef.id);
      return docRef.id;
    } catch (e) {
      console.error("Error adding group: ", e);
      return null;
    }
  }

  // Fungsi untuk mendapatkan semua grup
  async function getAllGroups() {
    try {
      const groupsCollection = collection(db, "groups");
      const groupsSnapshot = await getDocs(groupsCollection);
      const groupsList = groupsSnapshot.docs.map(doc => {
        return { id: doc.id, ...doc.data() };
      });
      return groupsList;
    } catch (e) {
      console.error("Error getting groups: ", e);
      return [];
    }
  }

  // Fungsi untuk bergabung dengan grup
  async function joinGroup(groupId, userId) {
    try {
      const groupRef = doc(db, "groups", groupId);
      const groupDoc = await getDoc(groupRef);
      
      if (groupDoc.exists()) {
        const members = groupDoc.data().members || [];
        if (!members.includes(userId)) {
          members.push(userId);
          await updateDoc(groupRef, { members: members });
          return true;
        }
      }
      return false;
    } catch (e) {
      console.error("Error joining group: ", e);
      return false;
    }
  }

  // Fungsi untuk membuat postingan baru
  async function createPost(groupId, author, content, title, attachments) {
    try {
      const postsCollection = collection(db, "groups", groupId, "posts");
      const docRef = await addDoc(postsCollection, {
        author: author,
        content: content,
        title: title || "",
        attachments: attachments || [],
        createdAt: new Date(),
        upvotes: 0,
        replies: []
      });
      console.log("Post created with ID: ", docRef.id);
      return docRef.id;
    } catch (e) {
      console.error("Error adding post: ", e);
      return null;
    }
  }

  // Fungsi untuk mendapatkan postingan dalam grup
  async function getPosts(groupId) {
    try {
      const postsCollection = collection(db, "groups", groupId, "posts");
      const q = query(postsCollection, orderBy("createdAt", "desc"));
      const postsSnapshot = await getDocs(q);
      const postsList = postsSnapshot.docs.map(doc => {
        return { id: doc.id, ...doc.data() };
      });
      return postsList;
    } catch (e) {
      console.error("Error getting posts: ", e);
      return [];
    }
  }

  // Fungsi untuk menambahkan balasan
  async function addReply(groupId, postId, author, text) {
    try {
      const postRef = doc(db, "groups", groupId, "posts", postId);
      const postDoc = await getDoc(postRef);
      
      if (postDoc.exists()) {
        const replies = postDoc.data().replies || [];
        replies.push({
          id: genId(),
          author: author,
          text: text,
          createdAt: new Date()
        });
        await updateDoc(postRef, { replies: replies });
        return true;
      }
      return false;
    } catch (e) {
      console.error("Error adding reply: ", e);
      return false;
    }
  }

  // Fungsi untuk upvote postingan
  async function upvotePost(groupId, postId) {
    try {
      const postRef = doc(db, "groups", groupId, "posts", postId);
      const postDoc = await getDoc(postRef);
      
      if (postDoc.exists()) {
        const upvotes = postDoc.data().upvotes || 0;
        await updateDoc(postRef, { upvotes: upvotes + 1 });
        return true;
      }
      return false;
    } catch (e) {
      console.error("Error upvoting post: ", e);
      return false;
    }
  }

  // Fungsi untuk login anonim
  async function anonymousLogin() {
    try {
      const userCredential = await signInAnonymously(auth);
      return userCredential.user;
    } catch (e) {
      console.error("Error signing in anonymously: ", e);
      return null;
    }
  }

  // Fungsi untuk memantau perubahan postingan secara real-time
  function listenToPosts(groupId, callback) {
    const postsCollection = collection(db, "groups", groupId, "posts");
    const q = query(postsCollection, orderBy("createdAt", "desc"));
    
    return onSnapshot(q, (querySnapshot) => {
      const postsList = [];
      querySnapshot.forEach((doc) => {
        postsList.push({ id: doc.id, ...doc.data() });
      });
      callback(postsList);
    });
  }

  // Fungsi untuk membuat notifikasi
  async function createNotification(userId, type, message, relatedId) {
    try {
      const notificationsCollection = collection(db, "users", userId, "notifications");
      const docRef = await addDoc(notificationsCollection, {
        type: type, // 'post', 'reply', 'quiz', etc.
        message: message,
        relatedId: relatedId, // ID of related item (post, quiz, etc.)
        read: false,
        createdAt: new Date()
      });
      console.log("Notification created with ID: ", docRef.id);
      return docRef.id;
    } catch (e) {
      console.error("Error creating notification: ", e);
      return null;
    }
  }

  // Fungsi untuk mendapatkan notifikasi pengguna
  async function getUserNotifications(userId) {
    try {
      const notificationsCollection = collection(db, "users", userId, "notifications");
      const q = query(notificationsCollection, orderBy("createdAt", "desc"));
      const notificationsSnapshot = await getDocs(q);
      const notificationsList = notificationsSnapshot.docs.map(doc => {
        return { id: doc.id, ...doc.data() };
      });
      return notificationsList;
    } catch (e) {
      console.error("Error getting notifications: ", e);
      return [];
    }
  }

  // Fungsi untuk menandai notifikasi sebagai dibaca
  async function markNotificationAsRead(userId, notificationId) {
    try {
      const notificationRef = doc(db, "users", userId, "notifications", notificationId);
      await updateDoc(notificationRef, { read: true });
      return true;
    } catch (e) {
      console.error("Error marking notification as read: ", e);
      return false;
    }
  }

  // Fungsi untuk menyimpan skor kuis
  async function saveQuizScore(userId, category, score, totalQuestions) {
    try {
      const scoresCollection = collection(db, "users", userId, "quizScores");
      const docRef = await addDoc(scoresCollection, {
        category: category,
        score: score,
        totalQuestions: totalQuestions,
        percentage: Math.round((score / totalQuestions) * 100),
        createdAt: new Date()
      });
      console.log("Quiz score saved with ID: ", docRef.id);
      return docRef.id;
    } catch (e) {
      console.error("Error saving quiz score: ", e);
      return null;
    }
  }

  // Fungsi untuk mendapatkan skor kuis pengguna
  async function getUserQuizScores(userId) {
    try {
      const scoresCollection = collection(db, "users", userId, "quizScores");
      const q = query(scoresCollection, orderBy("createdAt", "desc"));
      const scoresSnapshot = await getDocs(q);
      const scoresList = scoresSnapshot.docs.map(doc => {
        return { id: doc.id, ...doc.data() };
      });
      return scoresList;
    } catch (e) {
      console.error("Error getting quiz scores: ", e);
      return [];
    }
  }

  // Fungsi untuk memperbarui profil pengguna
  async function updateUserProfile(userId, profileData) {
    try {
      const userRef = doc(db, "users", userId);
      await updateDoc(userRef, profileData);
      return true;
    } catch (e) {
      console.error("Error updating user profile: ", e);
      return false;
    }
  }

  // Fungsi untuk mendapatkan profil pengguna
  async function getUserProfile(userId) {
    try {
      const userRef = doc(db, "users", userId);
      const userDoc = await getDoc(userRef);
      
      if (userDoc.exists()) {
        return userDoc.data();
      }
      return null;
    } catch (e) {
      console.error("Error getting user profile: ", e);
      return null;
    }
  }
</script>
</head>
<body>
  <!-- Development Banner -->
  <div class="development-banner">
    <span class="icon">üöß</span>
    <span class="text">üî• VERSI BETA - Masih dalam Tahap Pengembangan üî•</span>
    <span class="icon">‚ö°</span>
  </div>

  <header>
    <div class="brand">
      <div class="logo" style="background:none;box-shadow:none;padding:0;">
        <img src="https://iili.io/Kslta2e.png" alt="StudyPal Logo" style="width:44px;height:44px;border-radius:10px;object-fit:cover;">
      </div>
      <div>
        <h1>StudyPal</h1>
        <div class="small">Platform Belajar Kolaboratif</div>
      </div>
    </div>
    <nav>
      <button class="btn leaderboard" id="btn-leaderboard">üèÜ Papan Peringkat</button>
      <button class="btn" id="btn-quiz">Kuis Cepat</button>
      <button class="btn secondary" id="btn-login">Login / Register</button>
      <button class="btn secondary" id="btn-profile" style="display:none">Profil</button>
      <button class="btn secondary" id="btn-change-level" style="display:none">Ganti Jenjang</button>
      <div id="userArea" style="display:none" class="user-chip">
        <span id="notificationBadge" class="notification-badge" style="display:none">0</span>
      </div>
      <div id="notificationPanel" class="notification-panel">
        <div class="notification-header">Notifikasi</div>
        <div id="notificationList" class="notification-list"></div>
      </div>
    </nav>
  </header>

  <main class="container" id="app">
    <!-- Level Selection View -->
    <div id="levelSelectionView">
      <div class="level-selection-container">
        <h1 class="level-selection-title">Selamat Datang di StudyPal!</h1>
        <p class="level-selection-subtitle">Pilih jenjang pendidikan Anda untuk memulai</p>
        <div class="level-cards">
          <div class="level-card smp" data-level="smp">
            <div class="level-icon">üìö</div>
            <h3>SMP</h3>
            <p>Sekolah Menengah Pertama</p>
          </div>
          <div class="level-card sma" data-level="sma">
            <div class="level-icon">üéì</div>
            <h3>SMA</h3>
            <p>Sekolah Menengah Atas</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard View -->
    <div id="dashboardView">
      <!-- Hero -->
      <section class="hero-card hero">
        <div>
          <h2>Belajar lebih mudah bersama teman ‚Äî kapan saja, di mana saja</h2>
          <p>StudyPal membantu siswa membentuk grup belajar, berdiskusi, dan latihan soal interaktif. Cocok untuk tugas kelompok & persiapan ujian.</p>
          <div class="hero-actions">
            <button class="btn" id="startBtn">Mulai Belajar Sekarang</button>
            <button class="btn secondary" id="learnMore">Lihat Fitur</button>
          </div>

          <!-- Highlights -->
          <div class="grid" style="margin-top:18px">
            <div class="card">
              <strong>Forum Diskusi</strong>
              <div class="small" style="margin-top:6px">Tanya jawab & solusi soal antar siswa.</div>
            </div>
            <div class="card">
              <strong>Grup Belajar</strong>
              <div class="small" style="margin-top:6px">Buat grup sesuai kelas atau topik.</div>
            </div>
            <div class="card">
              <strong>Kuis Interaktif</strong>
              <div class="small" style="margin-top:6px">Latihan singkat untuk memperkuat pemahaman.</div>
            </div>
            <div class="card">
              <strong>Leaderboard</strong>
              <div class="small" style="margin-top:6px">Lihat peringkatmu dan bersaing dengan teman.</div>
            </div>
          </div>
        </div>

        <!-- right card: quick access -->
        <aside class="hero-card" style="text-align:center">
          <h3 style="margin-bottom:6px">Dashboard Cepat</h3>
          <p class="small">Pilih mata pelajaran untuk mulai bergabung di grup & berdiskusi</p>
          <div style="margin-top:12px" id="subjectQuick"></div>
        </aside>
      </section>

      <!-- Main layout: sidebar groups + forum -->
      <section id="mainArea" style="display:none" class="layout">
        <div class="sidebar card">
          <h3 style="margin:0 0 8px 0">Grup Study</h3>
          <div class="small">Pilih grup atau buat yang baru</div>
          <div id="groupList" class="group-list" style="margin-top:12px"></div>

          <button class="btn secondary full-width" id="btnCreateGroup" style="margin-top:12px">+ Buat Grup Baru</button>
        </div>

        <div class="card">
          <div id="groupHeader">
            <h2 style="margin:0">Pilih Grup</h2>
            <div class="small">Gabung ke grup untuk melihat forum</div>
          </div>

          <div id="forumArea" style="margin-top:12px;display:none">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <h3 id="groupTitle" style="margin:0">Group Title</h3>
                <div class="small" id="groupMeta">Mata pelajaran ‚Ä¢ 0 anggota</div>
              </div>
              <div>
                <button class="btn secondary" id="btnLeave">Keluar</button>
                <button class="btn" id="btnJoin">Gabung</button>
              </div>
            </div>

            <!-- Post composer -->
            <div style="margin-top:12px" class="post">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div style="width:44px;height:44px;border-radius:10px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:var(--primary);font-weight:700" id="avatarInitial">A</div>
                <div style="flex:1">
                  <textarea id="postText" rows="3" style="width:100%;padding:10px;border-radius:10px;border:1px solid #eef6fb;resize:vertical" placeholder="Tulis pertanyaan atau catatan..."></textarea>
                  
                  <!-- File attachment -->
                  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                    <button class="btn secondary" id="btnAttachFile" style="font-size:13px;padding:6px 10px">üìé Lampirkan File</button>
                    <input type="file" id="fileInput" style="display:none" multiple>
                    <div id="fileList" class="small"></div>
                  </div>
                  
                  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                    <div class="small">Tambahkan gambar atau link (opsional)</div>
                    <div>
                      <button class="btn secondary" id="btnClearPost">Bersihkan</button>
                      <button class="btn" id="btnPost">Kirim</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Post list -->
            <div id="postsContainer" style="margin-top:12px"></div>
          </div>

        </div>
      </section>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="profile-view">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2>Profil Saya</h2>
          <button class="btn secondary" id="btnBackToDashboard">‚Üê Kembali ke Dashboard</button>
        </div>
        
        <div class="profile-header">
          <div class="profile-avatar-large" id="profileAvatarLarge">A</div>
          <div class="profile-info">
            <h2 id="profileName">Nama Pengguna</h2>
            <p class="small" id="profileEmail">Belum ada email</p>
            <p class="small" id="profileBio">Belum ada bio</p>
          </div>
        </div>
        
        <div class="profile-stats">
          <div class="profile-stat">
            <div class="profile-stat-value" id="statGroups">0</div>
            <div class="profile-stat-label">Grup</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="statPosts">0</div>
            <div class="profile-stat-label">Postingan</div>
          </div>
          <div class="profile-stat">
            <div class="profile-stat-value" id="statQuizScore">0%</div>
            <div class="profile-stat-label">Skor Kuis Rata-rata</div>
          </div>
        </div>
        
        <div class="profile-content">
          <div class="profile-section">
            <h3>Grup Saya</h3>
            <div id="userGroupsList" class="profile-list">
              <div class="small">Belum bergabung dengan grup mana pun</div>
            </div>
          </div>
          
          <div class="profile-section">
            <h3>Postingan Saya</h3>
            <div id="userPostsList" class="profile-list">
              <div class="small">Belum ada postingan</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top:20px">
          <h3>Edit Profil</h3>
          <div style="margin-top:12px">
            <label class="small">Email (opsional)</label>
            <input id="profileEmailInput" class="input full-width" placeholder="email@example.com" style="margin-top:4px"/>
          </div>
          <div style="margin-top:12px">
            <label class="small">Bio (opsional)</label>
            <textarea id="profileBioInput" class="input full-width" rows="3" placeholder="Ceritakan sedikit tentang dirimu..." style="margin-top:4px"></textarea>
          </div>
          <div style="margin-top:12px">
            <button class="btn" id="profileSave">Simpan Perubahan</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <div class="small">StudyPal Beta ‚Ä¢ Masih dalam Tahap Pengembangan ‚Ä¢ Data tersimpan lokal di browser</div>
    </footer>
  </main>

  <!-- Modal: Login/Register -->
  <div id="modal" class="modal-backdrop">
    <div class="modal">
      <h3 id="modalTitle">Login / Register</h3>
      <p class="small" id="modalDesc">Masukkan nama pengguna untuk mulai menggunakan StudyPal</p>
      <input id="inputName" class="input" placeholder="Nama lengkap atau nama panggilan"/>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn secondary" id="modalCancel">Batal</button>
        <button class="btn" id="modalSave">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal: Create Group -->
  <div id="modalCreateGroup" class="modal-backdrop">
    <div class="modal">
      <h3>Buat Grup Baru</h3>
      <p class="small">Buat grup belajar untukmu dan teman-temanmu</p>
      
      <div style="margin-top:16px">
        <label class="small">Nama Grup *</label>
        <input id="groupNameInput" class="input full-width" placeholder="Contoh: Kelas 5A" style="margin-top:4px"/>
      </div>
      
      <div style="margin-top:12px">
        <label class="small">Mata Pelajaran *</label>
        <select id="groupSubjectInput" class="input full-width" style="margin-top:4px">
          <option value="">Pilih mata pelajaran</option>
        </select>
      </div>
      
      <div style="margin-top:12px">
        <label class="small">Deskripsi (opsional)</label>
        <textarea id="groupDescInput" class="input full-width" rows="3" placeholder="Deskripsikan tujuan grup ini" style="margin-top:4px"></textarea>
      </div>
      
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px">
        <button class="btn secondary" id="createGroupCancel">Batal</button>
        <button class="btn" id="createGroupSave">Buat Grup</button>
      </div>
    </div>
  </div>

  <!-- Modal: Quiz -->
  <div id="modalQuiz" class="modal-backdrop">
    <div class="modal" style="max-width:520px">
      <h3>Kuis Cepat</h3>
      <p class="small">Pilih kategori dan jawab soal untuk menguji pemahamanmu.</p>
      
      <!-- Quiz categories -->
      <div class="quiz-categories" id="quizCategories">
        <div class="quiz-category active" data-category="all">Semua</div>
      </div>
      
      <div id="quizContent" style="margin-top:8px"></div>
      <div id="quizResult" class="small"></div>
      <div id="quizResultDetails" class="quiz-result-details" style="display:none;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
        <div id="quizResult" class="small"></div>
        <div>
          <button class="btn secondary" id="quizClose">Tutup</button>
          <button class="btn" id="quizSubmit">Kirim Jawaban</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Leaderboard -->
  <div id="leaderboardModal" class="modal-backdrop">
    <div class="modal">
      <div class="leaderboard-header">
        <h3>üèÜ Papan Peringkat</h3>
        <button class="btn secondary" id="leaderboardClose">Tutup</button>
      </div>
      <div class="leaderboard-tabs">
        <div class="leaderboard-tab active" data-tab="all">Semua Waktu</div>
        <div class="leaderboard-tab" data-tab="smp">SMP</div>
        <div class="leaderboard-tab" data-tab="sma">SMA</div>
      </div>
      <div id="leaderboardContent">
        <!-- Leaderboard list will be populated by JS -->
      </div>
    </div>
  </div>

  <script>
    /***************
     * StudyPal Multi-Level with Leaderboard and Enhanced Quiz System
     * - Removed SD level and AI Beta features
     * - Added Leaderboard with tabs for different levels
     * - Enhanced quiz to show correct/incorrect answers
     * - Data, subjects, and quizzes are level-specific
     * - Added dedicated profile view and enhanced group creation
     * - Added file sharing, notifications, enhanced quiz system
     * - localStorage for persistence (groups & posts & username)
     ***************/

    // --- Constants ---
    const STORAGE_KEY = 'studypal_data_v1';
    const STORAGE_USER = 'studypal_user_v1';
    const STORAGE_PROFILE = 'studypal_profile_v1';
    const STORAGE_NOTIFICATIONS = 'studypal_notifications_v1';
    const STORAGE_QUIZ_SCORES = 'studypal_quiz_scores_v1';
    const STORAGE_LEVEL = 'studypal_level_v1';

    // --- util ---
    function genId(){ return 'id-' + Math.random().toString(36).slice(2,9) }
    function saveData(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)) }
    function loadData(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){ 
        const initialData = [];
        Object.keys(DATA_BY_LEVEL).forEach(level => {
            initialData.push(...DATA_BY_LEVEL[level].sampleGroups.map(g => ({...g, level})));
        });
        saveData(initialData); 
        return initialData.slice(); 
      }
      try{ return JSON.parse(raw) } catch(e){ 
        const initialData = [];
        Object.keys(DATA_BY_LEVEL).forEach(level => {
            initialData.push(...DATA_BY_LEVEL[level].sampleGroups.map(g => ({...g, level})));
        });
        saveData(initialData); 
        return initialData.slice(); 
      }
    }
    function formatDate(d){ 
      const date = new Date(d);
      return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    // --- Data by Level ---
    const DATA_BY_LEVEL = {
      smp: {
        subjects: [
          { name: "Matematika", icon: "üìê", class: "s-math" },
          { name: "Fisika", icon: "‚öõÔ∏è", class: "s-phys" },
          { name: "Biologi", icon: "üß¨", class: "s-bio" },
          { name: "Kimia", icon: "üß™", class: "s-bio" },
          { name: "Bahasa Indonesia", icon: "üìù", class: "s-indo" },
          { name: "Bahasa Inggris", icon: "üí¨", class: "s-eng" },
          { name: "IPS", icon: "üó∫Ô∏è", class: "s-ips" },
          { name: "PKN", icon: "üèõÔ∏è", class: "s-phys" },
          { name: "TIK", icon: "üíª", class: "s-info" }
        ],
        sampleGroups: [
          { id: genId(), name: "Kelas 7B", subject: "Matematika", members: [], posts: [], description: "Grup Matematika kelas 7B" },
          { id: genId(), name: "Fisika Fun", subject: "Fisika", members: [], posts: [], description: "Belajar fisika dengan menyenangkan" },
          { id: genId(), name: "English Club", subject: "Bahasa Inggris", members: [], posts: [], description: "Practice makes perfect" }
        ],
        quizQuestions: {
          matematika: [
            { q: '1) Persamaan garis lurus dengan gradien 2 dan melalui titik (0,3) adalah...', a: ['y = 2x + 3', 'y = 3x + 2', 'y = 2x - 3', 'y = -2x + 3'], correct: 0 },
            { q: '2) Hasil dari (2x + 3)(x - 1) adalah...', a: ['2x¬≤ + x - 3', '2x¬≤ - x + 3', '2x¬≤ + x + 3', '2x¬≤ - x - 3'], correct: 0 },
            { q: '3) Akar kuadrat dari 144 adalah...', a: ['10', '11', '12', '13'], correct: 2 }
          ],
          fisika: [
            { q: '1) Satuan dari percepatan adalah...', a: ['m/s', 'm/s¬≤', 'kg¬∑m/s¬≤', 'J'], correct: 1 },
            { q: '2) Gaya gravitasi bekerja ke arah...', a: ['Atas', 'Bawah', 'Samping', 'Tengah'], correct: 1 },
            { q: '3) Energi yang dimiliki benda karena geraknya disebut energi...', a: ['Potensial', 'Kinetik', 'Mekanik', 'Kimia'], correct: 1 }
          ]
        }
      },
      sma: {
        subjects: [
          { name: "Matematika", icon: "‚à´", class: "s-math" },
          { name: "Fisika", icon: "‚ö°", class: "s-phys" },
          { name: "Biologi", icon: "üß´", class: "s-bio" },
          { name: "Kimia", icon: "üßØ", class: "s-bio" },
          { name: "Bahasa Indonesia", icon: "üìú", class: "s-indo" },
          { name: "Bahasa Inggris", icon: "üåê", class: "s-eng" },
          { name: "Ekonomi", icon: "üíπ", class: "s-geo" },
          { name: "Geografi", icon: "üåè", class: "s-geo" },
          { name: "Sosiologi", icon: "üë•", class: "s-geo" },
          { name: "Sejarah", icon: "üìö", class: "s-geo" },
          { name: "PAI", icon: "‚ò™Ô∏è", class: "s-pai" },
          { name: "Informatika", icon: "üë®‚Äçüíª", class: "s-info" },
          { name: "Bahasa Jawa", icon: "Í¶≤", class: "s-jawa" }
        ],
        sampleGroups: [
          { id: genId(), name: "Kelas 11 IPA 1", subject: "Matematika", members: [], posts: [], description: "Grup untuk belajar matematika kelas 11 IPA 1" },
          { id: genId(), name: "Persiapan UN 12 IPA",
